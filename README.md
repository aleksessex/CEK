CEK public-key cryptosystem
===========================

(master branch) [![Build Status](https://travis-ci.org/ChrisCates/CEK.svg?branch=master)](https://travis-ci.org/ChrisCates/CEK)

(testing branch) [![Build Status](https://travis-ci.org/ChrisCates/CEK.svg?branch=testing)](https://travis-ci.org/ChrisCates/CEK)

A Python reference implementation of the Carlton-Essex-Kapulkin cryptosystem.

CEK is a probabilistic asymmteric-key cryptosystem in <a href="https://www.codecogs.com/eqnedit.php?latex=\mathbb{Z}^*_n" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\mathbb{Z}^*_n" title="\mathbb{Z}^*_n" /></a>. It has a threshold homomorphic property that causes the encrypted plaintext to map to a singular value if it exceeds a given threshold.

Publication
-----------

Rhys Carlton and Aleksander Essex and Krzysztof Kapulkin.
_Threshold Properties of Prime Power Subgroups with Application to Secure Integer Comparisons_.
The Cryptographers' Track at the RSA Conference 2018, San Francisco, CA, USA, April 16-20, 2018

Paper on IACR ePrint archive: [[PDF]](https://eprint.iacr.org/2018/224)

Requirements and Setup
----------------------

1. Unix OS
2. python 2 or python 3 and clang (for gmp)
3. gmp library

```
# For Mac OS (requires homebrew)
brew install mpfr
brew install libmpc
brew install gmp

# For Debian OSes
sudo apt-get install libmpfr-dev
sudo apt-get install libmpc-dev
sudo apt-get install libgmp2-dev

# For RHEL OSes
sudo yum install libmpfr-dev
sudo yum install libmpc-dev
sudo yum install libgmp2-dev
```

4. Required python packages installed via pip

```
sudo pip install -r ./requirements.txt
```

Running Tests
-------------

1. To run via pytest

```
sh pytest.sh
```

2. To run as plain python application

```
sh test.sh
```

Usage
-----

### Generate a new keypair

```
>>> from CEK.cek import Cryptosystem
>>> cs = Cryptosystem()
>>> cs.generate_key()
>>> cs.pub_key
{'n': 1692078151146443754803252297622759281268633932946682011218087153064369773286368356300986198274323481997491808794247574620081798456263164366404339870472978935320090313348408248137068984498616889074953472682704749503262254875826884602441417734097314937278978349502564600670575988503860189032278593526256909085487116420927774112039472029958269923812006598648080136159578782383113144624416134405240531194604107508591865567013023082103974511797164072549088532486216627458557225142557985757759762368215452720218528869721328483498204157028187579574079192491423506520347636630221110604635932859013630569106404986219378245633, 'g': 1219479500576864469905633802246572043694584862097779197544344607841040786105036630275538705769021938415415859238586237511419662049553199460654515129736049722667212857796152043911766417825759748003148601757221548222546881539277256710032038035983408423228125799573017818881066548005788020790616090298977632919792981487931998941769659763333081570837885254646304677438359399640236020427801430636254263198376695293301528773308589815830743784100202928711709960766995416466899906556918680406536987478403500840172165882432591901394534887827209253032418603913202328596078460855554926171219650129505978398746165347575365823989, 'h': 1165725892129316026055923105322618375974043698380082344558658860426869674588108877068427113758160237780433326534132221008576339359215853291951333645510615067516573158681538130154109611437344281613395793024225511909373408032122038497578835658708448896936864051181264487157395120543617674431388091832279125599189541297750613151613561081442152163683624180227512178665101617137855895147132247287247017624039714435023721266268834585728188296526257884182786035880791803986710890124125375972747568915325816290692859034027887873365810694426195371787570149585352103237379841020486679385591772392129147304909249001963650358091, 'b': 2, 'd': 256, 'u': 224}
>>> cs.prv_key
{'x': 365021790643396970164436454547960049232638887101746141188202313941983288507091414594160991288121210415179787631174381651114216568872826826653697, 'p_s': 23080235812440171697650676108989042997938572877473022600369483808613, 'p': 40751525352587931656022156794592909311520252803333402174823866384575989496559777766251135894647801878286706070993732553422167807358063627458394027055365379866276125797184284757267473733688185038550937084349207669907881624165452250410085728885798520980539516351406113183496625967763507811435430268566247571457}
```

### Write key to file

```
>>> cs.write_key("mykey")
```

### Load key from file

```
>>> cs.load_key("test_vectors/CEK-112.pub", "test_vectors/CEK-112.prv")
>>> cs.prv_key
{'x': 40080299147116080555904932857719618241603724667699420824202666260999334875216258293148791510667058302980120475190333026054776934355540964802561, 'p_s': 683128826082354240850632589248932099866139046085330464747838649351, 'p': 3528863583711725403916594447490841168781795918900952592884290690343226913766780050072110223204138046569244068424260897135573272241314779781655870949322365525503187140231283825896360840735556421707009559498973423830222835162455143006801980735886497187188261944808534313203665069844695874474424242815486656513}
```

### Encrypt and decrypt

```
>>> c = cs.encrypt(0)
>>> c
mpz(280899710399793647942846531241839407557077914390094664685192828100524888544916396574500522197221370485318678512873870450318852227654451863108415802607034384916323164927876909663638231581798584381581680696583320015713352973179737225332681826112388052550704653358779969938097957441724700663197006533017239430453954180573952234251167801021463904718497404504287669588877720494658855903496208451094414573817210166265346604688658363178420944187304030204617652404110196245150664600992343455607022775323028036125473867969319120754991670286613859434793025345596644510329560396018722706329600106437529719754466997079839176566L)
>>> cs.decrypt(c)
0
```

### Scalar homomorphic addition

```
>>> c = cs.encrypt(1)
>>> c
mpz(162235144329082531184456034205199076610918170774112970697684802101347646131244231790822295054033383306622321721502928941727728066229876343255276910769109356966934817611010474488387268231697713678675373588375899452920783652948725157653392578236443708642925345531572833762397635428168399363274888496893882879506891509483587881849383310486224618587371613926400538942759330385651975878297353243053954142966429888198994957921902874388034184659033344340089786889758088313167600738065315721097217638792766051565979368013150382798947475501741222002853252266038073778135167540902720933928997968378385745845633587342410149547L)
>>> c = cs.add(c, 10)
>>> c
mpz(10132415095308076451984736923325294103799519150913767287229558728809895771382580338834951022426453081610324357473450252837653848648405450682087782785727285135173777856750286685532056687938382823596065409568807626080942502927707566998889464410208893431810738112517550381977112996884195166528495303557735868778246528693183308503459207094330379401487532741646352908973404435816762299459127492015339527306899317649209650073161819440630983584756751100887597399228380356866909712205962219113588873180843042836277760064031353161734293259345931754942625021908492254676110513791890652635438173740755673704595305059004470538L)
>>> cs.decrypt(c)
11
```

### Demonstration of threshold homomorphic property

An interesting feature of the cryptosytem is that the plaintext takes on a fixed "infinite" value when it hits a certain threshold. In this example we encrypt the number 250 and homomorphically increment it by 1 past the threshold `pub_key.d = 256`. At each step, we decrypt to see the resulting plaintext.

```
>>> from CEK.cek import Cryptosystem
>>> cs = Cryptosystem()
>>> cs.load_key("test_vectors/CEK-112.pub", "test_vectors/CEK-112.prv")
>>> c = cs.encrypt(250)
>>> for i in range(1,10):
...     c = cs.add(c, 1)
...     print cs.decrypt(c)
...
251
252
253
254
255
Inf
Inf
Inf
Inf
```

Observe when the plaintext reaches the threhsold `d`=256, it takes on this fixed value (`Inf`), after which the scalar homomorphic addition operation produces no change to the underlying plaintext.

To show you this in greater detail, we'll print out the ciphertexts at each step:

```
>>> c = cs.encrypt(250)
>>> for i in range(1,10):
...     c = cs.add(c, 1)
...     print c
...     print cs.decrypt(c)
...
248218327032847603553177689973713140206903151917197493347990558857392534753894145101908278493985928202208699666895780895234633136902328820793947392948629665936160393137248131005119548989280304672829788401613211787228605817394004322875085431928060074155919713015947982203263344961048538910657279570136201122721496615543057425750552043955994040395628430057978200128598128740568797387282056834029309509004678855947853207200793642169903275680370002453999623698240723713334064138390693504982924167709084233404376886885163483111094691535335077545191694507313712278172601572174064871307693905676760174768724320732877976515
251
183876361371697517071574399618208283983535109828666603729980024492085484230099286286140140106082561871871577922752379937099905030595884988640766639242760766498708046785692270396385824744522482390021980468219170403343640506444461181002195613645549353557201804619089298107564728479261133748083187731642257665249605432477787769025848848437145122711944759793087861644201920070750539385709021124009733219557621584020017048393433045418522384038321288862337131215609980893206281326450975920014728805045116048117814005672930263357755351824375505596667077760294214708910517492187377649811752967437606642821811515627140148219
252
254636676445321512512561570504973625848386416534520982153548511658522638177697528506175382233198324117835403699343439517799032958000237402325416325169033555215237040403203081219906603229722890655055737395909229528567078417310472932458323335789067860511996568469902145062373522959394644032571871381419932751058105197538408050094633019660043031172486145176446276661554513906223052090171126624211883838063554862209367420034029614840178713685773011806880855633351287727203124786333809735500245790766209224343475574327007527599032183173984822884265189659383931378547513879398521210680683657259735808632670486152219467097
253
266472401904715927857228946097793163643982259959696986294710855805220450356884876137117475920044815843500444387302730598593833948400011286940198328579358275195031187580746388455948711720140054518129085781823980286544834894806340550073494257107197288093016494451421693740919319774580881638441555777858267158821353299309666855093150806099236494630896922984931929817916252617697816484690608819048389552150336643602010932850374462334981645017574618737769793287452483192607500933777708960697652104072089584177726614196327697098254851261591334939037278722622250215509818433731971536864447458625975369749694151352840015435
254
98916238750519358790583281926519630595976694390211548804704363362169172452246703395260385119348757087440622652749417843990896236153691838400523664810117124576650610966312840965462776090953416232647098312160872052778916531771724118412634003325114201139084263310567694003151529575330231114640191189308759178675152318403953965119102795616306533040171225414541719940447448483428269148092215966135639168194860638530852622747839114845286684426505219467887654550314157015912297892646335864161389802023182739366927985323700704799550552349661460277116579504367245891539132744495231841784166770907151304840705134115433833518
255
185070945937220221140310902089424154652049242626515715294293283352843557881052546256871977865399057226536837035633817020094755992689392259046250553923263392760581749200084195990597477449268480781774138478677722015039203567770231952317050007944402135370702616500541914125127489892029495298019969548575918350771418895904919627839144722689046064492828544475765640556003508241321547712409646598134719942017488240093790603088314946243152700128273506910763151819394990604818854495705588646554705375177852432518103718820125074181202364793874465617686884168896306574971441842804271017685805982677724266355226071037615446911
Inf
69622680233739688349172590373079259614889389984687443027260492123789568265150654081267343211185762384071497288134838023889900986949565129292527737935901543989331955461025245925852245678683586014989235635937395197936412217917898151874801490021458164312372419048446312676503422311976505033314960804947299371288695038736226907338109836076879870362336298260265825769450683738557387655259838977307086375357991554085063243482850038653643658645643348536935969148356452439173970961363113721983439908829950995590298467007249926328737735640558670152840245515271645015083435352486437282137465590475799525002379696639347735484
Inf
116807189499918875784622669370710126798273196258461868238664290442730467732156615171979027492000727141656050508807947509451134029465823498143016172130189168873647573457045488710510613610023747339317396664854640851904346420276796113287070830227629368922345546615957151159417025627827084216151026299545213796536314366493271528620551103835224089250908576851695756543965347006533758266375727965535065511002879185546651186945542666353126052160718110084984800371802666598109242060454811807272211983321149544548842895299468854879061405659022767819096634159229020726135615590930691108735099945730291691832104171470947655021
Inf
271115111267884527000204690722571661869517075816815613412942244081996842276860227378495663714346368842021381413530420328262904644382275576963474796812291680608964790561738637008890122672860323729811174422992939145549932665770668403015591857076814719381689604853415198674516521536133149239655477991486196874224566627957248354553579800943241726064451196142930580009270560716269770154080770125905999554482823433500737231790788210845755075891566188875998112290943207882680169530099580978324288572544417690981844617270640704825205863143164122295808014089266210010129959541767823754290029981578766573523377531781470919095
Inf
```

Double checking the last two ciphertexts we find:

```
>>> cs.decrypt(116807189499918875784622669370710126798273196258461868238664290442730467732156615171979027492000727141656050508807947509451134029465823498143016172130189168873647573457045488710510613610023747339317396664854640851904346420276796113287070830227629368922345546615957151159417025627827084216151026299545213796536314366493271528620551103835224089250908576851695756543965347006533758266375727965535065511002879185546651186945542666353126052160718110084984800371802666598109242060454811807272211983321149544548842895299468854879061405659022767819096634159229020726135615590930691108735099945730291691832104171470947655021)
'Inf'
>>> cs.decrypt(271115111267884527000204690722571661869517075816815613412942244081996842276860227378495663714346368842021381413530420328262904644382275576963474796812291680608964790561738637008890122672860323729811174422992939145549932665770668403015591857076814719381689604853415198674516521536133149239655477991486196874224566627957248354553579800943241726064451196142930580009270560716269770154080770125905999554482823433500737231790788210845755075891566188875998112290943207882680169530099580978324288572544417690981844617270640704825205863143164122295808014089266210010129959541767823754290029981578766573523377531781470919095)
'Inf'
```

Or double checking more directly we get:

```
>>> import gmpy2
>>> gmpy2.powmod(116807189499918875784622669370710126798273196258461868238664290442730467732156615171979027492000727141656050508807947509451134029465823498143016172130189168873647573457045488710510613610023747339317396664854640851904346420276796113287070830227629368922345546615957151159417025627827084216151026299545213796536314366493271528620551103835224089250908576851695756543965347006533758266375727965535065511002879185546651186945542666353126052160718110084984800371802666598109242060454811807272211983321149544548842895299468854879061405659022767819096634159229020726135615590930691108735099945730291691832104171470947655021, cs.prv_key.p_s, cs.prv_key.p)
mpz(1)
>>> gmpy2.powmod(271115111267884527000204690722571661869517075816815613412942244081996842276860227378495663714346368842021381413530420328262904644382275576963474796812291680608964790561738637008890122672860323729811174422992939145549932665770668403015591857076814719381689604853415198674516521536133149239655477991486196874224566627957248354553579800943241726064451196142930580009270560716269770154080770125905999554482823433500737231790788210845755075891566188875998112290943207882680169530099580978324288572544417690981844617270640704825205863143164122295808014089266210010129959541767823754290029981578766573523377531781470919095, cs.prv_key.p_s, cs.prv_key.p)
mpz(1)
```

## Why this works

Encryption is defined on top of a subgroup of prime power order. Let g be a generator of a subgroup of the ring of integers modulo n, with an order b^d for prime b. Encryption is defined as:

```
Enc(m) = g^{b^m}h^r mod n
```

First, consider Enc(0):

```
Enc(0) = g^{b^0}h^r mod n
       = g^{1}h^r mod n
```

Since g has order b^d, then exponents of g modulo n are taken modulo b^d. Using default parameters b=2, d=256 and with m=255 we have:

```
Enc(255) = g^{2^255}h^r mod n
         = g^{2^255 mod 2^256}h^r mod n
         = g^{2^255}h^r mod n
```

Decrypting this returns 255. But if we had m=256 we have:

```
Enc(256) = g^{2^256}h^r mod n
         = g^{2^256 mod 2^256}h^r mod n
         = g^{0}h^r mod n
         = h^r mod n
```
Decrypting this we find 2^m = 0, so we define m to be infinite ('`Inf`'). Now suppose m=257. We still have:

```
Enc(257) = g^{2^257}h^r mod n
         = g^{2^257 mod 2^256}h^r mod n
         = g^{0}h^r mod n
         = h^r mod n
```

Suppose m=1,000,000. We still have:

```
Enc(1,000,000) = g^{2^1,000,000}h^r mod n
               = g^{2^1,000,000 mod 2^256}h^r mod n
               = g^{0}h^r mod n
               = h^r mod n
```

Therefore the cryptosystem implements a kind threshold homomomrphic function:

```
Dec(Enc(m))  = m     if 0 <= m < d
             = Inf   otherwise
```



License and Copyright
---------------------
MIT, see [LICENSE][1]

(C) 2018 Aleksander Essex

[1]: https://github.com/aleksessex/CEK/blob/master/LICENSE